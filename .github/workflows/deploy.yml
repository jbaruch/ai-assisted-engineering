name: ğŸš€ Deploy to GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      
    - name: ï¿½ Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
        
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running test suite..."
        
        # Run core functionality tests
        echo "ğŸ“‹ Running core functionality tests..."
        if [ -f "tests/test-core-functionality.js" ]; then
          bun tests/test-core-functionality.js
          if [ $? -eq 0 ]; then
            echo "âœ… Core functionality tests passed"
          else
            echo "âŒ Core functionality tests failed"
            exit 1
          fi
        else
          echo "âš ï¸ Core functionality tests not found"
        fi
        
        # Run YouTube API tests (only if API key is available)
        echo "ğŸ”‘ Running YouTube API tests..."
        if [ -f "tests/test-youtube-api.js" ]; then
          if [ -n "$YOUTUBE_API_KEY" ]; then
            bun tests/test-youtube-api.js
            if [ $? -eq 0 ]; then
              echo "âœ… YouTube API tests passed"
            else
              echo "âŒ YouTube API tests failed"
              exit 1
            fi
          else
            echo "âš ï¸ Skipping YouTube API tests - no API key available"
          fi
        else
          echo "âš ï¸ YouTube API tests not found"
        fi
        
        echo "ğŸ‰ All tests completed successfully!"
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        
    - name: ğŸ¥ Generate video configuration with YouTube Data API v3
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      run: |
        echo "ğŸ” Checking video configuration..."
        
        # Check if config.js exists and has recent video data
        if [ -f "config.js" ]; then
          echo "âœ… Found existing config.js"
          
          # Check if config has video data
          if grep -q "videoConfig" config.js && grep -q "title" config.js; then
            echo "âœ… Video configuration found in config.js"
            
            # Show video count and first video for verification
            video_count=$(grep -c '"id":' config.js || echo "0")
            echo "ğŸ“Š Found $video_count videos in config"
            
            if [ "$video_count" -gt 0 ]; then
              echo "ğŸ“¹ First video:"
              grep -A 2 '"title":' config.js | head -3 | sed 's/^/   /'
            fi
          else
            echo "âš ï¸ config.js exists but has no video data, regenerating..."
            REGENERATE=true
          fi
        else
          echo "âŒ config.js not found, generating from URLs..."
          REGENERATE=true
        fi
        
        # Generate config if needed
        if [ "$REGENERATE" = "true" ]; then
          if [ -f "urls.txt" ]; then
            echo "ğŸ”„ Generating video configuration from urls.txt..."
            
            if [ -n "$YOUTUBE_API_KEY" ]; then
              echo "ğŸ”‘ YouTube API key found, using YouTube Data API v3..."
              bun generate-video-config.js
              
              # Verify generation was successful
              if [ -f "config.js" ] && grep -q "videoConfig" config.js; then
                video_count=$(grep -c '"id":' config.js || echo "0")
                echo "âœ… Successfully generated config.js with $video_count videos"
              else
                echo "âŒ Failed to generate config.js with API"
                exit 1
              fi
            else
              echo "âš ï¸ No YouTube API key found in secrets"
              echo "ğŸ’¡ Please add YOUTUBE_API_KEY to repository secrets"
              echo "ğŸ”„ Creating fallback config with placeholder data..."
              
              # Create a basic fallback config
              echo '// Video Configuration - Fallback (API key not available)' > config.js
              echo 'const videoConfig = [' >> config.js
              echo '    {' >> config.js
              echo '        "id": "placeholder",' >> config.js
              echo '        "title": "Video Configuration Unavailable",' >> config.js
              echo '        "description": "YouTube API key not configured. Please add YOUTUBE_API_KEY to repository secrets.",' >> config.js
              echo '        "thumbnail": "https://via.placeholder.com/480x360?text=API+Key+Required"' >> config.js
              echo '    }' >> config.js
              echo '];' >> config.js
              echo '' >> config.js
              echo 'if (typeof module !== "undefined" && module.exports) {' >> config.js
              echo '    module.exports = videoConfig;' >> config.js
              echo '}' >> config.js
              echo "âš ï¸ Created fallback config - site will deploy but videos won't work properly"
            fi
          else
            echo "âŒ No urls.txt found - cannot generate video configuration"
            exit 1
          fi
        fi
        
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4
        
    - name: ğŸ“¦ Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./
        destination: ./_site
          
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Post-deployment verification
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        
      - name: ï¿½ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: ğŸ” Post-deployment verification
        run: |
          echo "ğŸ” Running post-deployment verification..."
          
          # Run basic functionality tests to ensure deployment is working
          if [ -f "tests/test-core-functionality.js" ]; then
            echo "ğŸ“‹ Verifying core functionality after deployment..."
            bun tests/test-core-functionality.js
            if [ $? -eq 0 ]; then
              echo "âœ… Post-deployment verification passed"
            else
              echo "âŒ Post-deployment verification failed"
              exit 1
            fi
          else
            echo "âš ï¸ Core functionality tests not found for verification"
          fi
          
          echo "ğŸ‰ Deployment verification completed successfully!"
